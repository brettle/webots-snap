os: linux
dist: bionic
language: generic
sudo: required
services:
  - xvfb
after_failure: >
  if [ "$TRAVIS_EVENT_TYPE" = "cron" ]; then curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"Webots need your Help! Nightly build failed during the '$(echo $TRAVIS_BUILD_STAGE_NAME)' stage on the '$(echo $TRAVIS_BRANCH)' branch: $(echo $TRAVIS_BUILD_WEB_URL)\" }" $DISCORD_WEBHOOK; fi
install:
  - sudo snap install snapcraft --classic
  - git clone --recurse-submodules --depth 3 --single-branch --branch $WEBOTS_TARGET_BRANCH https://github.com/cyberbotics/webots.git
script:
  - export COMMIT_ID=$(cd webots; git rev-parse HEAD)
  - if [ "$TRAVIS_EVENT_TYPE" = "cron" ]; then python webots/src/packaging/set_commit_and_date_in_version.py $COMMIT_ID; fi
  - sudo snapcraft --destructive-mode
  - cp *.snap webots/distribution
  - src/packaging/publish_release.py --key=$GITHUB_API_KEY --repo=https://github.com/cyberbotics/webots --branch=$WEBOTS_TARGET_BRANCH --commit=$COMMIT_ID --tag=$TRAVIS_TAG
