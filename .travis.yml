os: linux
dist: bionic
language: generic
sudo: required
cache:
  directories:
    - /root/parts/webots
services:
  - xvfb
jobs:
  include:
    - &snap_pull
      stage: Snap Pull
      name: Snap Pull
      install:
        - sudo rm -rf /root/parts/webots
        - sudo snap install snapcraft --classic
        - sudo snap install multipass --beta --classic
        - git clone --recurse-submodules --depth 3 --single-branch --branch $WEBOTS_TARGET_BRANCH https://github.com/cyberbotics/webots.git
      script:
        - sudo snapcraft pull
    - &snap_build
      stage: Snap Build
      name: Snap Build
      install:
        - sudo snap install snapcraft --classic
        - sudo snap install multipass --beta --classic
        - git clone --recurse-submodules --depth 3 --single-branch --branch $WEBOTS_TARGET_BRANCH https://github.com/cyberbotics/webots.git
      script:
        - sudo snapcraft build
    - &snap
      stage: Snap
      name: Snap
      install:
        - sudo snap install snapcraft --classic
        - sudo snap install multipass --beta --classic
        - git clone --recurse-submodules --depth 3 --single-branch --branch $WEBOTS_TARGET_BRANCH https://github.com/cyberbotics/webots.git
      script:
        - export COMMIT_ID=$(cd webots; git rev-parse HEAD)
        - sudo snapcraft snap
        - cp *.snap webots/distribution
        - src/packaging/publish_release.py --key=$GITHUB_API_KEY --repo=https://github.com/cyberbotics/webots --branch=$WEBOTS_TARGET_BRANCH --commit=$COMMIT_ID --tag=$TRAVIS_TAG
